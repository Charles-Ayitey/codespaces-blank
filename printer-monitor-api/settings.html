<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - Printer Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class', theme: { extend: { colors: { gray: { 850: '#1f2937', 750: '#374151' } } } } }
  </script>
</head>
<body class="bg-gray-100 dark:bg-gray-850 min-h-screen">
  <!-- Header -->
  <header class="bg-white dark:bg-gray-750 shadow-sm border-b border-gray-200 dark:border-gray-600">
    <div class="max-w-4xl mx-auto px-4 py-4">
      <div class="flex items-center gap-4">
        <a href="standalone_dashboard.html" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
        </a>
        <div class="flex-1">
          <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">‚öôÔ∏è Settings</h1>
          <p class="text-sm text-gray-500 dark:text-gray-300">Configure notifications, alerts, and reports</p>
        </div>
        <button onclick="toggleDarkMode()" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600" title="Toggle dark mode">
          <svg id="dark-mode-icon" class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all">
      <span id="toast-message"></span>
    </div>

    <!-- Tabs -->
    <div class="bg-white dark:bg-gray-750 rounded-xl shadow-sm border border-gray-200 dark:border-gray-600 mb-6">
      <div class="flex border-b dark:border-gray-600">
        <button onclick="switchTab('email')" id="tab-email" class="px-6 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600 dark:text-blue-400">
          üìß Email
        </button>
        <button onclick="switchTab('webhooks')" id="tab-webhooks" class="px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
          üîó Webhooks
        </button>
        <button onclick="switchTab('alerts')" id="tab-alerts" class="px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
          üîî Alerts
        </button>
        <button onclick="switchTab('reports')" id="tab-reports" class="px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
          üìä Reports
        </button>
      </div>

      <!-- Email Tab -->
      <div id="panel-email" class="p-6">
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold text-gray-800 dark:text-white">Email Notifications</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">Receive alerts via email</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="email-enabled" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 dark:bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">SMTP Host</label>
              <input type="text" id="email-host" placeholder="smtp.gmail.com" class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Port</label>
              <input type="number" id="email-port" placeholder="587" class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username (Email)</label>
              <input type="email" id="email-user" placeholder="alerts@company.com" class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password / App Password</label>
              <input type="password" id="email-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
          </div>

          <div class="flex items-center gap-2">
            <input type="checkbox" id="email-secure" class="rounded border-gray-300">
            <label for="email-secure" class="text-sm text-gray-700">Use SSL/TLS (port 465)</label>
          </div>

          <!-- Gmail Help Box -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 class="font-medium text-blue-800 mb-2">üìß Gmail Setup Guide</h4>
            <ol class="text-sm text-blue-700 list-decimal list-inside space-y-1">
              <li>Host: <code class="bg-blue-100 px-1 rounded">smtp.gmail.com</code></li>
              <li>Port: <code class="bg-blue-100 px-1 rounded">587</code> (leave SSL unchecked) or <code class="bg-blue-100 px-1 rounded">465</code> (check SSL)</li>
              <li>Username: Your full Gmail address</li>
              <li>Password: Use an <strong>App Password</strong> (not your regular password)</li>
            </ol>
            <p class="text-xs text-blue-600 mt-2">
              To create an App Password: Google Account ‚Üí Security ‚Üí 2-Step Verification ‚Üí App passwords
            </p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Recipients</label>
            <div id="recipients-list" class="space-y-2 mb-2"></div>
            <div class="flex gap-2">
              <input type="email" id="new-recipient" placeholder="Add email address" class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <button onclick="addRecipient()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Add</button>
            </div>
          </div>

          <button onclick="testEmail()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
            Send Test Email
          </button>
        </div>
      </div>

      <!-- Webhooks Tab -->
      <div id="panel-webhooks" class="p-6 hidden">
        <div class="space-y-4">
          <div>
            <h3 class="font-semibold text-gray-800">Webhook Integrations</h3>
            <p class="text-sm text-gray-500">Send alerts to Slack, Discord, Teams, or custom webhooks</p>
          </div>

          <div id="webhooks-list" class="space-y-3"></div>

          <div class="border-t pt-4">
            <h4 class="font-medium text-gray-700 mb-2">Add New Webhook</h4>
            <div class="grid grid-cols-3 gap-2">
              <input type="text" id="new-webhook-name" placeholder="Name (e.g., Slack)" class="px-3 py-2 border rounded-lg">
              <input type="url" id="new-webhook-url" placeholder="Webhook URL" class="col-span-2 px-3 py-2 border rounded-lg">
            </div>
            <button onclick="addWebhook()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Add Webhook</button>
          </div>
        </div>
      </div>

      <!-- Alerts Tab -->
      <div id="panel-alerts" class="p-6 hidden">
        <div class="space-y-6">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold text-gray-800">Alert System</h3>
              <p class="text-sm text-gray-500">Enable or disable all alerts</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="alerts-enabled" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Low Supply Threshold: <span id="low-supply-value">20</span>%</label>
            <input type="range" id="low-supply-threshold" min="5" max="50" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Alert when toner/ink falls below this level</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Critical Supply Threshold: <span id="critical-supply-value">10</span>%</label>
            <input type="range" id="critical-supply-threshold" min="1" max="30" value="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Urgent alert when supply is critically low</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Offline Alert After: <span id="offline-value">5</span> minutes</label>
            <input type="range" id="offline-minutes" min="1" max="30" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Wait this long before alerting about offline printers</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Alert Cooldown: <span id="cooldown-value">4</span> hours</label>
            <input type="range" id="cooldown-hours" min="1" max="24" value="4" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Minimum time between repeated alerts for the same issue</p>
          </div>

          <!-- Notification Schedule -->
          <div class="border-t pt-6 mt-6">
            <h4 class="font-semibold text-gray-800 mb-4">üìß Email Notification Schedule</h4>
            <p class="text-sm text-gray-500 mb-4">Control when you receive alert emails</p>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">When to Send Notifications</label>
              <select id="notify-schedule" onchange="updateNotifyScheduleOptions()" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="always">Always (24/7)</option>
                <option value="business-hours">Business Hours Only</option>
                <option value="scheduled">Custom Schedule</option>
              </select>
            </div>

            <div id="notify-schedule-options" class="hidden space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Start Time</label>
                  <input type="time" id="notify-start-time" value="08:00" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">End Time</label>
                  <input type="time" id="notify-end-time" value="18:00" class="w-full px-3 py-2 border rounded-lg">
                </div>
              </div>

              <div id="notify-days-selection">
                <label class="block text-sm font-medium text-gray-700 mb-2">Active Days</label>
                <div class="flex flex-wrap gap-2">
                  <label class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 has-[:checked]:bg-blue-500 has-[:checked]:text-white">
                    <input type="checkbox" value="0" class="notify-day sr-only"> Sun
                  </label>
                  <label class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 has-[:checked]:bg-blue-500 has-[:checked]:text-white">
                    <input type="checkbox" value="1" class="notify-day sr-only" checked> Mon
                  </label>
                  <label class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 has-[:checked]:bg-blue-500 has-[:checked]:text-white">
                    <input type="checkbox" value="2" class="notify-day sr-only" checked> Tue
                  </label>
                  <label class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 has-[:checked]:bg-blue-500 has-[:checked]:text-white">
                    <input type="checkbox" value="3" class="notify-day sr-only" checked> Wed
                  </label>
                  <label class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 has-[:checked]:bg-blue-500 has-[:checked]:text-white">
                    <input type="checkbox" value="4" class="notify-day sr-only" checked> Thu
                  </label>
                  <label class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 has-[:checked]:bg-blue-500 has-[:checked]:text-white">
                    <input type="checkbox" value="5" class="notify-day sr-only" checked> Fri
                  </label>
                  <label class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 has-[:checked]:bg-blue-500 has-[:checked]:text-white">
                    <input type="checkbox" value="6" class="notify-day sr-only"> Sat
                  </label>
                </div>
              </div>
            </div>

            <!-- Schedule Summary -->
            <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
              <p id="notify-schedule-summary" class="text-sm text-blue-700">üì¨ Notifications will be sent immediately when alerts are triggered</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Reports Tab -->
      <div id="panel-reports" class="p-6 hidden">
        <div class="space-y-6">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold text-gray-800">Scheduled Reports</h3>
              <p class="text-sm text-gray-500">Automatically generate and email reports</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="reports-enabled" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Schedule Frequency</label>
              <select id="report-schedule" onchange="updateScheduleOptions()" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="custom">Custom Days</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Time to Send</label>
              <input type="time" id="report-time" value="08:00" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
          </div>

          <!-- Weekly/Custom Days Selection -->
          <div id="days-selection" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Select Days</label>
            <div class="flex flex-wrap gap-2">
              <label class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 has-[:checked]:bg-blue-500 has-[:checked]:text-white">
                <input type="checkbox" value="0" class="report-day sr-only"> Sun
              </label>
              <label class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 has-[:checked]:bg-blue-500 has-[:checked]:text-white">
                <input type="checkbox" value="1" class="report-day sr-only" checked> Mon
              </label>
              <label class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 has-[:checked]:bg-blue-500 has-[:checked]:text-white">
                <input type="checkbox" value="2" class="report-day sr-only"> Tue
              </label>
              <label class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 has-[:checked]:bg-blue-500 has-[:checked]:text-white">
                <input type="checkbox" value="3" class="report-day sr-only"> Wed
              </label>
              <label class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 has-[:checked]:bg-blue-500 has-[:checked]:text-white">
                <input type="checkbox" value="4" class="report-day sr-only"> Thu
              </label>
              <label class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 has-[:checked]:bg-blue-500 has-[:checked]:text-white">
                <input type="checkbox" value="5" class="report-day sr-only"> Fri
              </label>
              <label class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 has-[:checked]:bg-blue-500 has-[:checked]:text-white">
                <input type="checkbox" value="6" class="report-day sr-only"> Sat
              </label>
            </div>
          </div>

          <!-- Monthly Day Selection -->
          <div id="monthly-selection" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Day of Month</label>
            <select id="report-day-of-month" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              ${[...Array(28)].map((_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Report Format</label>
            <select id="report-format" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="pdf">PDF</option>
              <option value="csv">CSV</option>
            </select>
          </div>

          <div class="flex items-center gap-2">
            <input type="checkbox" id="report-email" class="rounded border-gray-300">
            <label for="report-email" class="text-sm text-gray-700">Email reports to recipients</label>
          </div>

          <!-- Schedule Summary -->
          <div id="schedule-summary" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 class="font-medium text-blue-800 mb-1">üìÖ Schedule Summary</h4>
            <p id="schedule-summary-text" class="text-sm text-blue-700">Reports will be sent weekly on Monday at 08:00</p>
          </div>

          <div class="border-t pt-4">
            <h4 class="font-medium text-gray-700 mb-3">Generate Report Now</h4>
            <div class="flex gap-2">
              <a href="#" onclick="downloadReport('usage', 'pdf')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">üìÑ Usage (PDF)</a>
              <a href="#" onclick="downloadReport('usage', 'csv')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">üìä Usage (CSV)</a>
              <a href="#" onclick="downloadReport('supplies', 'pdf')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">üñ®Ô∏è Supplies (PDF)</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Save Button -->
    <div class="flex justify-end">
      <button onclick="saveSettings()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        Save Settings
      </button>
    </div>
  </main>

  <script>
    const API_BASE = 'http://localhost:5000/api';
    let config = {};

    // Dark mode functions
    function initDarkMode() {
      const isDark = localStorage.getItem('darkMode') === 'true' || 
                    (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches);
      if (isDark) {
        document.documentElement.classList.add('dark');
      }
      updateDarkModeIcon();
    }

    function toggleDarkMode() {
      document.documentElement.classList.toggle('dark');
      const isDark = document.documentElement.classList.contains('dark');
      localStorage.setItem('darkMode', isDark);
      updateDarkModeIcon();
    }

    function updateDarkModeIcon() {
      const icon = document.getElementById('dark-mode-icon');
      if (!icon) return;
      const isDark = document.documentElement.classList.contains('dark');
      if (isDark) {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
      } else {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>';
      }
    }

    // Tab switching
    function switchTab(tab) {
      document.querySelectorAll('[id^="panel-"]').forEach(p => p.classList.add('hidden'));
      document.querySelectorAll('[id^="tab-"]').forEach(t => {
        t.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
        t.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
      });
      
      document.getElementById(`panel-${tab}`).classList.remove('hidden');
      document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
      document.getElementById(`tab-${tab}`).classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMsg = document.getElementById('toast-message');
      
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
      toastMsg.textContent = message;
      toast.classList.remove('hidden');
      
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    // Load settings
    async function loadSettings() {
      try {
        const response = await fetch(`${API_BASE}/settings`);
        config = await response.json();
        
        // Email
        document.getElementById('email-enabled').checked = config.email?.enabled || false;
        document.getElementById('email-host').value = config.email?.host || '';
        document.getElementById('email-port').value = config.email?.port || 587;
        document.getElementById('email-user').value = config.email?.user || '';
        // Don't populate password with masked value - show placeholder if password exists
        document.getElementById('email-pass').value = '';
        document.getElementById('email-pass').placeholder = config.email?.pass ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢  (saved)' : 'Enter password';
        document.getElementById('email-secure').checked = config.email?.secure || false;
        renderRecipients();
        
        // Webhooks
        renderWebhooks();
        
        // Alerts
        document.getElementById('alerts-enabled').checked = config.alerts?.enabled !== false;
        document.getElementById('low-supply-threshold').value = config.alerts?.lowSupplyThreshold || 20;
        document.getElementById('critical-supply-threshold').value = config.alerts?.criticalSupplyThreshold || 10;
        document.getElementById('offline-minutes').value = config.alerts?.offlineMinutes || 5;
        document.getElementById('cooldown-hours').value = config.alerts?.cooldownHours || 4;
        updateSliderValues();
        
        // Notification schedule
        document.getElementById('notify-schedule').value = config.alerts?.notifySchedule || 'always';
        document.getElementById('notify-start-time').value = config.alerts?.notifyTime || '08:00';
        document.getElementById('notify-end-time').value = config.alerts?.notifyEndTime || '18:00';
        const notifyDays = config.alerts?.notifyDays || [1, 2, 3, 4, 5];
        document.querySelectorAll('.notify-day').forEach(checkbox => {
          checkbox.checked = notifyDays.includes(parseInt(checkbox.value));
        });
        updateNotifyScheduleOptions();
        
        // Reports
        document.getElementById('reports-enabled').checked = config.reports?.enabled || false;
        document.getElementById('report-schedule').value = config.reports?.schedule || 'weekly';
        document.getElementById('report-format').value = config.reports?.format || 'pdf';
        document.getElementById('report-email').checked = config.reports?.emailOnGenerate || false;
        document.getElementById('report-time').value = config.reports?.time || '08:00';
        
        // Load day of month for monthly
        const dayOfMonthSelect = document.getElementById('report-day-of-month');
        if (dayOfMonthSelect) {
          dayOfMonthSelect.value = config.reports?.dayOfMonth || 1;
        }
        
        // Load selected days for weekly/custom
        const selectedDays = config.reports?.days || [1];
        document.querySelectorAll('.report-day').forEach(checkbox => {
          checkbox.checked = selectedDays.includes(parseInt(checkbox.value));
        });
        
        updateScheduleOptions();
        
      } catch (error) {
        showToast('Failed to load settings', 'error');
      }
    }

    // Update slider display values
    function updateSliderValues() {
      document.getElementById('low-supply-value').textContent = document.getElementById('low-supply-threshold').value;
      document.getElementById('critical-supply-value').textContent = document.getElementById('critical-supply-threshold').value;
      document.getElementById('offline-value').textContent = document.getElementById('offline-minutes').value;
      document.getElementById('cooldown-value').textContent = document.getElementById('cooldown-hours').value;
    }

    // Render recipients list
    function renderRecipients() {
      const list = document.getElementById('recipients-list');
      const recipients = config.email?.recipients || [];
      
      list.innerHTML = recipients.map((r, i) => `
        <div class="flex items-center gap-2 p-2 bg-gray-50 rounded">
          <span class="flex-1">${r}</span>
          <button onclick="removeRecipient(${i})" class="text-red-500 hover:text-red-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      `).join('');
    }

    // Add recipient
    function addRecipient() {
      const input = document.getElementById('new-recipient');
      const email = input.value.trim();
      
      if (email && email.includes('@')) {
        if (!config.email) config.email = { recipients: [] };
        if (!config.email.recipients) config.email.recipients = [];
        config.email.recipients.push(email);
        renderRecipients();
        input.value = '';
      }
    }

    // Remove recipient
    function removeRecipient(index) {
      config.email.recipients.splice(index, 1);
      renderRecipients();
    }

    // Render webhooks list
    function renderWebhooks() {
      const list = document.getElementById('webhooks-list');
      const webhooks = config.webhooks || [];
      
      list.innerHTML = webhooks.map((wh, i) => `
        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" ${wh.enabled ? 'checked' : ''} onchange="toggleWebhook(${i})" class="sr-only peer">
            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
          </label>
          <div class="flex-1">
            <p class="font-medium text-gray-800">${wh.name || 'Webhook'}</p>
            <p class="text-sm text-gray-500">${wh.url}</p>
          </div>
          <button onclick="testWebhook(${i})" class="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm">Test</button>
          <button onclick="removeWebhook(${i})" class="text-red-500 hover:text-red-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      `).join('') || '<p class="text-gray-500 text-center py-4">No webhooks configured</p>';
    }

    // Add webhook
    function addWebhook() {
      const name = document.getElementById('new-webhook-name').value.trim();
      const url = document.getElementById('new-webhook-url').value.trim();
      
      if (url) {
        if (!config.webhooks) config.webhooks = [];
        config.webhooks.push({ name: name || 'Webhook', url, enabled: true });
        renderWebhooks();
        document.getElementById('new-webhook-name').value = '';
        document.getElementById('new-webhook-url').value = '';
      }
    }

    // Toggle webhook
    function toggleWebhook(index) {
      config.webhooks[index].enabled = !config.webhooks[index].enabled;
    }

    // Remove webhook
    function removeWebhook(index) {
      config.webhooks.splice(index, 1);
      renderWebhooks();
    }

    // Test email
    async function testEmail() {
      try {
        const response = await fetch(`${API_BASE}/settings/test-email`, { method: 'POST' });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'error');
      } catch (error) {
        showToast('Failed to send test email', 'error');
      }
    }

    // Test webhook
    async function testWebhook(index) {
      try {
        const response = await fetch(`${API_BASE}/settings/test-webhook`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ webhookIndex: index })
        });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'error');
      } catch (error) {
        showToast('Failed to send test webhook', 'error');
      }
    }

    // Save settings
    async function saveSettings() {
      const passwordField = document.getElementById('email-pass').value;
      const settings = {
        email: {
          enabled: document.getElementById('email-enabled').checked,
          host: document.getElementById('email-host').value,
          port: parseInt(document.getElementById('email-port').value) || 587,
          secure: document.getElementById('email-secure').checked,
          user: document.getElementById('email-user').value,
          // Only include password if user entered a new one, otherwise send null to preserve existing
          pass: passwordField.trim() ? passwordField : null,
          recipients: config.email?.recipients || []
        },
        webhooks: config.webhooks || [],
        alerts: {
          enabled: document.getElementById('alerts-enabled').checked,
          lowSupplyThreshold: parseInt(document.getElementById('low-supply-threshold').value),
          criticalSupplyThreshold: parseInt(document.getElementById('critical-supply-threshold').value),
          offlineMinutes: parseInt(document.getElementById('offline-minutes').value),
          cooldownHours: parseInt(document.getElementById('cooldown-hours').value),
          notifySchedule: document.getElementById('notify-schedule').value,
          notifyDays: getSelectedNotifyDays(),
          notifyTime: document.getElementById('notify-start-time').value,
          notifyEndTime: document.getElementById('notify-end-time').value
        },
        reports: {
          enabled: document.getElementById('reports-enabled').checked,
          schedule: document.getElementById('report-schedule').value,
          format: document.getElementById('report-format').value,
          emailOnGenerate: document.getElementById('report-email').checked,
          time: document.getElementById('report-time').value,
          days: getSelectedDays(),
          dayOfMonth: parseInt(document.getElementById('report-day-of-month').value) || 1
        }
      };
      
      try {
        const response = await fetch(`${API_BASE}/settings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          showToast('Settings saved successfully!');
          loadSettings(); // Reload to get masked values
        } else {
          showToast('Failed to save settings', 'error');
        }
      } catch (error) {
        showToast('Failed to save settings', 'error');
      }
    }

    // Download report
    function downloadReport(type, format) {
      window.open(`${API_BASE}/reports/${type}?format=${format}`, '_blank');
    }

    // Get selected days from checkboxes
    function getSelectedDays() {
      const days = [];
      document.querySelectorAll('.report-day:checked').forEach(checkbox => {
        days.push(parseInt(checkbox.value));
      });
      return days.length > 0 ? days : [1]; // Default to Monday if none selected
    }

    // Update schedule options visibility based on selected frequency
    function updateScheduleOptions() {
      const schedule = document.getElementById('report-schedule').value;
      const daysSelection = document.getElementById('days-selection');
      const monthlySelection = document.getElementById('monthly-selection');
      
      // Show/hide appropriate options
      if (schedule === 'weekly' || schedule === 'custom') {
        daysSelection.classList.remove('hidden');
        monthlySelection.classList.add('hidden');
      } else if (schedule === 'monthly') {
        daysSelection.classList.add('hidden');
        monthlySelection.classList.remove('hidden');
      } else {
        daysSelection.classList.add('hidden');
        monthlySelection.classList.add('hidden');
      }
      
      updateScheduleSummary();
    }

    // Update the schedule summary text
    function updateScheduleSummary() {
      const schedule = document.getElementById('report-schedule').value;
      const time = document.getElementById('report-time').value;
      const summaryText = document.getElementById('schedule-summary-text');
      
      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const time12 = formatTime12(time);
      
      let summary = '';
      
      if (schedule === 'daily') {
        summary = `Reports will be sent daily at ${time12}`;
      } else if (schedule === 'weekly') {
        const selectedDays = getSelectedDays().map(d => dayNames[d]).join(', ');
        summary = `Reports will be sent weekly on ${selectedDays} at ${time12}`;
      } else if (schedule === 'monthly') {
        const dayOfMonth = document.getElementById('report-day-of-month').value;
        const suffix = getDaySuffix(dayOfMonth);
        summary = `Reports will be sent on the ${dayOfMonth}${suffix} of each month at ${time12}`;
      } else if (schedule === 'custom') {
        const selectedDays = getSelectedDays().map(d => dayNames[d]).join(', ');
        summary = `Reports will be sent on ${selectedDays} at ${time12}`;
      }
      
      summaryText.textContent = summary;
    }

    // Format time to 12-hour format
    function formatTime12(time24) {
      const [hours, minutes] = time24.split(':');
      const h = parseInt(hours);
      const ampm = h >= 12 ? 'PM' : 'AM';
      const h12 = h % 12 || 12;
      return `${h12}:${minutes} ${ampm}`;
    }

    // Get day suffix (1st, 2nd, 3rd, etc.)
    function getDaySuffix(day) {
      const d = parseInt(day);
      if (d >= 11 && d <= 13) return 'th';
      switch (d % 10) {
        case 1: return 'st';
        case 2: return 'nd';
        case 3: return 'rd';
        default: return 'th';
      }
    }

    // Event listeners for sliders
    document.querySelectorAll('input[type="range"]').forEach(slider => {
      slider.addEventListener('input', updateSliderValues);
    });

    // Event listeners for schedule updates
    document.getElementById('report-time').addEventListener('change', updateScheduleSummary);
    document.getElementById('report-day-of-month').addEventListener('change', updateScheduleSummary);
    document.querySelectorAll('.report-day').forEach(checkbox => {
      checkbox.addEventListener('change', updateScheduleSummary);
    });
    
    // Event listeners for notification schedule
    document.getElementById('notify-schedule').addEventListener('change', updateNotifyScheduleOptions);
    document.getElementById('notify-start-time').addEventListener('change', updateNotifyScheduleSummary);
    document.getElementById('notify-end-time').addEventListener('change', updateNotifyScheduleSummary);
    document.querySelectorAll('.notify-day').forEach(checkbox => {
      checkbox.addEventListener('change', updateNotifyScheduleSummary);
    });
    
    // Get selected notification days
    function getSelectedNotifyDays() {
      const days = [];
      document.querySelectorAll('.notify-day:checked').forEach(checkbox => {
        days.push(parseInt(checkbox.value));
      });
      return days.length > 0 ? days : [1, 2, 3, 4, 5]; // Default to weekdays
    }
    
    // Update notification schedule options visibility
    function updateNotifyScheduleOptions() {
      const schedule = document.getElementById('notify-schedule').value;
      const scheduleOptions = document.getElementById('notify-schedule-options');
      const daysSelection = document.getElementById('notify-days-selection');
      
      if (schedule === 'always') {
        scheduleOptions.classList.add('hidden');
      } else {
        scheduleOptions.classList.remove('hidden');
      }
      
      // Only show days selection for custom schedule
      if (schedule === 'scheduled') {
        daysSelection.classList.remove('hidden');
      } else {
        daysSelection.classList.add('hidden');
      }
      
      updateNotifyScheduleSummary();
    }
    
    // Update notification schedule summary
    function updateNotifyScheduleSummary() {
      const schedule = document.getElementById('notify-schedule').value;
      const startTime = document.getElementById('notify-start-time').value;
      const endTime = document.getElementById('notify-end-time').value;
      const summaryEl = document.getElementById('notify-schedule-summary');
      
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const start12 = formatTime12(startTime);
      const end12 = formatTime12(endTime);
      
      let summary = '';
      
      if (schedule === 'always') {
        summary = 'üì¨ Notifications will be sent immediately when alerts are triggered';
      } else if (schedule === 'business-hours') {
        summary = `üì¨ Notifications from ${start12} to ${end12}, Monday-Friday`;
      } else if (schedule === 'scheduled') {
        const selectedDays = getSelectedNotifyDays().map(d => dayNames[d]).join(', ');
        summary = `üì¨ Notifications from ${start12} to ${end12} on ${selectedDays}`;
      }
      
      summaryEl.textContent = summary;
    }

    // Initialize
    initDarkMode();
    loadSettings();
  </script>
</body>
</html>
