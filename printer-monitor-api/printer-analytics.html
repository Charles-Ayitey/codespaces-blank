<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Printer Analytics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    .chart-container { position: relative; height: 280px; }
    .chart-container-lg { position: relative; height: 350px; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="analytics.html" class="text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
          </a>
          <div>
            <h1 id="printerName" class="text-2xl font-bold text-gray-800">üìä Printer Analytics</h1>
            <p id="printerIp" class="text-sm text-gray-500">Loading...</p>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <select id="timeRange" class="px-3 py-2 border rounded-lg bg-white text-sm">
            <option value="1">Last 1 Hour</option>
            <option value="6">Last 6 Hours</option>
            <option value="24" selected>Last 24 Hours</option>
          </select>
          <button onclick="refreshData()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Refresh
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Current Status Card -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 mb-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">üìç Current Status</h3>
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div class="text-center p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500">Status</p>
          <p id="currentStatus" class="text-xl font-bold text-gray-800">-</p>
        </div>
        <div class="text-center p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500">Total Pages</p>
          <p id="currentPages" class="text-xl font-bold text-blue-600">-</p>
        </div>
        <div class="text-center p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500">Pages Today</p>
          <p id="pagesToday" class="text-xl font-bold text-green-600">-</p>
        </div>
        <div class="text-center p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500">Uptime</p>
          <p id="uptimePercent" class="text-xl font-bold text-purple-600">-</p>
        </div>
        <div class="text-center p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500">Last Update</p>
          <p id="lastUpdate" class="text-xl font-bold text-gray-600">-</p>
        </div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Avg Pages/Day</p>
            <p id="avgPagesDay" class="text-3xl font-bold text-gray-800">-</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Total Tracked</p>
            <p id="totalTracked" class="text-3xl font-bold text-gray-800">-</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Days Tracked</p>
            <p id="daysTracked" class="text-3xl font-bold text-gray-800">-</p>
          </div>
          <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Low Supplies</p>
            <p id="lowSupplies" class="text-3xl font-bold text-orange-600">-</p>
          </div>
          <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Page Count History -->
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìà Page Count History</h3>
        <div class="chart-container-lg">
          <canvas id="pageCountChart"></canvas>
        </div>
      </div>
      
      <!-- Daily Print Volume -->
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìä Daily Print Volume</h3>
        <div class="chart-container-lg">
          <canvas id="dailyVolumeChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Supply Levels Over Time -->
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">üé® Supply Level Trends</h3>
        <div class="chart-container-lg">
          <canvas id="supplyChart"></canvas>
        </div>
      </div>
      
      <!-- Uptime History -->
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">‚è±Ô∏è Daily Uptime</h3>
        <div class="chart-container-lg">
          <canvas id="uptimeChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Current Supplies -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 mb-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">üñ®Ô∏è Current Supply Levels</h3>
      <div id="supplyBars" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <p class="text-gray-500 col-span-full text-center py-4">Loading supplies...</p>
      </div>
    </div>

    <!-- Usage Predictions -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">üîÆ Usage Predictions</h3>
      <div id="predictions" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <p class="text-gray-500 col-span-full text-center py-4">Not enough data for predictions</p>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = 'http://localhost:5000/api';
    let printerIp = null;
    let pageCountChart, dailyVolumeChart, supplyChart, uptimeChart;

    // Get printer IP from URL
    function getPrinterIp() {
      const params = new URLSearchParams(window.location.search);
      return params.get('ip');
    }

    // Initialize charts
    function initCharts() {
      // Page Count History
      const pageCtx = document.getElementById('pageCountChart').getContext('2d');
      pageCountChart = new Chart(pageCtx, {
        type: 'line',
        data: { datasets: [] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
              title: { display: true, text: 'Time' }
            },
            y: { title: { display: true, text: 'Total Pages' }, beginAtZero: false }
          },
          plugins: { legend: { display: false } }
        }
      });

      // Daily Volume
      const dailyCtx = document.getElementById('dailyVolumeChart').getContext('2d');
      dailyVolumeChart = new Chart(dailyCtx, {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { title: { display: true, text: 'Pages Printed' }, beginAtZero: true }
          },
          plugins: { legend: { display: false } }
        }
      });

      // Supply Levels
      const supplyCtx = document.getElementById('supplyChart').getContext('2d');
      supplyChart = new Chart(supplyCtx, {
        type: 'line',
        data: { datasets: [] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } }
            },
            y: { min: 0, max: 100, title: { display: true, text: 'Level %' } }
          },
          plugins: { legend: { position: 'bottom' } }
        }
      });

      // Uptime Chart
      const uptimeCtx = document.getElementById('uptimeChart').getContext('2d');
      uptimeChart = new Chart(uptimeCtx, {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { min: 0, max: 100, title: { display: true, text: 'Uptime %' } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    // Get supply color
    function getSupplyColor(name) {
      const n = name.toLowerCase();
      if (n.includes('cyan')) return { bg: 'bg-cyan-500', text: 'rgb(0, 188, 212)' };
      if (n.includes('magenta')) return { bg: 'bg-pink-500', text: 'rgb(233, 30, 99)' };
      if (n.includes('yellow')) return { bg: 'bg-yellow-400', text: 'rgb(255, 193, 7)' };
      if (n.includes('black')) return { bg: 'bg-gray-800', text: 'rgb(33, 33, 33)' };
      return { bg: 'bg-gray-400', text: 'rgb(158, 158, 158)' };
    }

    // Load current printer data
    async function loadCurrentPrinter() {
      try {
        const response = await fetch(`${API_BASE}/printers/${printerIp}`);
        if (!response.ok) throw new Error('Printer not found');
        
        const printer = await response.json();
        
        // Update header
        document.getElementById('printerName').textContent = `üìä ${printer.name || printer.ip}`;
        document.getElementById('printerIp').textContent = `IP: ${printer.ip} | Serial: ${printer.serial || 'N/A'}`;
        
        // Update current status
        document.getElementById('currentStatus').textContent = printer.status || 'Unknown';
        document.getElementById('currentStatus').className = `text-xl font-bold ${printer.online ? 'text-green-600' : 'text-red-600'}`;
        document.getElementById('currentPages').textContent = (printer.totalPages || 0).toLocaleString();
        document.getElementById('lastUpdate').textContent = new Date(printer.lastUpdate).toLocaleTimeString();
        
        // Update supply bars
        const supplyBars = document.getElementById('supplyBars');
        const tonerSupplies = (printer.supplies || []).filter(s => {
          const name = s.name.toLowerCase();
          return (name.includes('toner') || name.includes('ink')) && 
                 !name.includes('drum') && !name.includes('fuser');
        });
        
        if (tonerSupplies.length > 0) {
          let lowCount = 0;
          supplyBars.innerHTML = tonerSupplies.map(supply => {
            const percentage = supply.max > 0 ? Math.round((supply.current / supply.max) * 100) : 0;
            if (percentage < 20 && percentage >= 0) lowCount++;
            const color = getSupplyColor(supply.name);
            const barColor = percentage < 10 ? 'bg-red-500' : percentage < 20 ? 'bg-orange-400' : color.bg;
            
            return `
              <div class="p-4 bg-gray-50 rounded-lg">
                <div class="flex justify-between mb-2">
                  <span class="text-sm font-medium text-gray-700">${supply.name}</span>
                  <span class="text-sm font-bold ${percentage < 20 ? 'text-orange-600' : 'text-gray-800'}">${percentage}%</span>
                </div>
                <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-full ${barColor} transition-all" style="width: ${Math.min(100, Math.max(0, percentage))}%"></div>
                </div>
              </div>
            `;
          }).join('');
          
          document.getElementById('lowSupplies').textContent = lowCount;
        } else {
          supplyBars.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">No toner supplies detected</p>';
          document.getElementById('lowSupplies').textContent = '0';
        }
        
      } catch (error) {
        console.error('Failed to load printer:', error);
        document.getElementById('printerName').textContent = '‚ùå Printer Not Found';
      }
    }

    // Load printer history
    async function loadPrinterHistory() {
      const minutes = parseInt(document.getElementById('timeRange').value) * 60;
      
      try {
        const response = await fetch(`${API_BASE}/history/printer/${printerIp}?minutes=${minutes}`);
        const data = await response.json();
        
        // Update page count chart
        if (data.recentHistory.length > 0) {
          pageCountChart.data.datasets = [{
            label: 'Total Pages',
            data: data.recentHistory.map(h => ({
              x: new Date(h.timestamp),
              y: h.totalPages
            })),
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.1,
            fill: true
          }];
          pageCountChart.update();
          
          // Update supply chart
          const supplies = {};
          data.recentHistory.forEach(snapshot => {
            snapshot.supplies?.forEach(supply => {
              // Filter to toner/ink only
              const name = supply.name.toLowerCase();
              if (!name.includes('toner') && !name.includes('ink')) return;
              if (name.includes('drum') || name.includes('fuser')) return;
              
              if (!supplies[supply.name]) {
                supplies[supply.name] = [];
              }
              supplies[supply.name].push({
                x: new Date(snapshot.timestamp),
                y: supply.percentage
              });
            });
          });

          supplyChart.data.datasets = Object.entries(supplies).map(([name, chartData]) => {
            const color = getSupplyColor(name);
            return {
              label: name.substring(0, 20),
              data: chartData,
              borderColor: color.text,
              backgroundColor: color.text.replace('rgb', 'rgba').replace(')', ', 0.1)'),
              tension: 0.1,
              fill: true
            };
          });
          supplyChart.update();
        }
        
        // Update daily charts
        if (data.dailyHistory.length > 0) {
          const dates = data.dailyHistory.map(d => d.date);
          const volumes = data.dailyHistory.map(d => d.pagesPrinted);
          const uptimes = data.dailyHistory.map(d => d.uptimePercent);
          
          dailyVolumeChart.data.labels = dates;
          dailyVolumeChart.data.datasets = [{
            label: 'Pages Printed',
            data: volumes,
            backgroundColor: 'rgb(16, 185, 129)'
          }];
          dailyVolumeChart.update();
          
          uptimeChart.data.labels = dates;
          uptimeChart.data.datasets = [{
            label: 'Uptime %',
            data: uptimes,
            backgroundColor: uptimes.map(u => u >= 90 ? 'rgb(16, 185, 129)' : u >= 70 ? 'rgb(245, 158, 11)' : 'rgb(239, 68, 68)')
          }];
          uptimeChart.update();
          
          // Calculate stats
          const totalTracked = volumes.reduce((a, b) => a + b, 0);
          const avgPerDay = Math.round(totalTracked / volumes.length);
          const todayPages = volumes[volumes.length - 1] || 0;
          const avgUptime = Math.round(uptimes.reduce((a, b) => a + b, 0) / uptimes.length);
          
          document.getElementById('avgPagesDay').textContent = avgPerDay.toLocaleString();
          document.getElementById('totalTracked').textContent = totalTracked.toLocaleString();
          document.getElementById('daysTracked').textContent = dates.length;
          document.getElementById('pagesToday').textContent = todayPages.toLocaleString();
          document.getElementById('uptimePercent').textContent = `${avgUptime}%`;
          
          // Update predictions
          updatePredictions(data.dailyHistory, avgPerDay);
        } else {
          document.getElementById('avgPagesDay').textContent = '-';
          document.getElementById('totalTracked').textContent = '-';
          document.getElementById('daysTracked').textContent = '0';
          document.getElementById('pagesToday').textContent = '-';
          document.getElementById('uptimePercent').textContent = '-';
        }
        
      } catch (error) {
        console.error('Failed to load history:', error);
      }
    }

    // Update predictions based on usage
    function updatePredictions(dailyHistory, avgPerDay) {
      const predictions = document.getElementById('predictions');
      
      if (dailyHistory.length < 2) {
        predictions.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">Need at least 2 days of data for predictions</p>';
        return;
      }
      
      // Get latest supply levels
      const latestSupplies = dailyHistory[dailyHistory.length - 1]?.supplyLevels || [];
      const tonerSupplies = latestSupplies.filter(s => {
        const name = s.name.toLowerCase();
        return (name.includes('toner') || name.includes('ink')) && 
               !name.includes('drum') && !name.includes('fuser') &&
               s.percentage >= 0 && s.percentage <= 100;
      });
      
      if (tonerSupplies.length === 0) {
        predictions.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">No supply data available for predictions</p>';
        return;
      }
      
      // Calculate supply depletion rate (very rough estimate)
      // Assume ~5000 pages per toner cartridge on average
      const pagesPerPercent = 50; // Rough estimate
      
      predictions.innerHTML = tonerSupplies.map(supply => {
        const daysRemaining = avgPerDay > 0 ? Math.round((supply.percentage * pagesPerPercent) / avgPerDay) : 999;
        const color = getSupplyColor(supply.name);
        const urgency = daysRemaining < 7 ? 'text-red-600 bg-red-50' : daysRemaining < 14 ? 'text-orange-600 bg-orange-50' : 'text-green-600 bg-green-50';
        
        return `
          <div class="p-4 ${urgency} rounded-lg border">
            <p class="text-sm font-medium text-gray-700">${supply.name}</p>
            <p class="text-2xl font-bold mt-1">${daysRemaining < 999 ? `~${daysRemaining} days` : 'N/A'}</p>
            <p class="text-xs text-gray-500 mt-1">At current usage rate</p>
          </div>
        `;
      }).join('');
    }

    // Refresh all data
    async function refreshData() {
      await loadCurrentPrinter();
      await loadPrinterHistory();
    }

    // Event listeners
    document.getElementById('timeRange').addEventListener('change', loadPrinterHistory);

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      printerIp = getPrinterIp();
      
      if (!printerIp) {
        document.getElementById('printerName').textContent = '‚ùå No Printer Selected';
        document.getElementById('printerIp').textContent = 'Please select a printer from the dashboard';
        return;
      }
      
      initCharts();
      refreshData();
      
      // Auto-refresh every 2 minutes
      setInterval(refreshData, 120000);
    });
  </script>
</body>
</html>
